4.10 本练习题将考查资源冒险、控制冒险和指令集体系结构设计如何影响流水线的执行。本练习题
中的问题涉及下面的MIPS代码片段
sw r16,12(r6)
lw r16,8(r6)
beq r5,r4,Labe1 # Assume r5!=r4
add r5,r1,r4
slt r5,r15,r4
假定每个流水级的延迟如下:
IF      ID      EX      MEM     WB
200ps  120ps   150ps   190ps   100ps
4.10.1 [10] <4.5>假设所有的分支都被正确预测(控制冒险完全被消除)且没有使用延迟时间槽,
并且只有一个存储器(既存储指令又存储数据)。如果一个时钟周期内同时取指和取数据就会
发生结构冒险。为保证前进，该冒险必须始终以有利于取数指令的方式解决。该指令序列在仅
有一个存储器的五级流水线中执行的总时间是多少?我们知道插人nop指令可以消除数据冒
险，可以用同样的方法消除这里的结构冒险吗?为什么?
4.10.2 [20] <4. 5>假设所有的分支都被正确预测(控制冒险完全被消除)且没有使用延迟时间槽。
如果我们改变存取指令的格式，仅使用寄存器(不含偏移地址)进行寻址，那么这些指令不再
需要使用ALU。结果是MEM级和EX级可以重叠成-级，整个流水线也就成为四级。改变该代
码以适应上述ISA的改变。假设这个改变不影响时钟周期，对该指令序列而言,这个改变造成
的加速比是多少?
4.10.3 [10] <4.5>假设在分支时进行阻塞且没有使用延迟时间槽，那么在ID级确定分支方向相对于
在EX级确定分支方向的加速比是多少?
4.10.4 [10] <4.5>在给定的流水级延迟下，重做练习题4.10.2,考虑可能的时钟周期变化。如果EX
级和MEM级重叠起来，它们的大部分工作可以并行执行。这样重叠后的EX/MEM级的延迟是
原来两级的较大者，不能并行工作时延迟还要再加20ps。
4.10.5 [10] <4.5>在给定的流水级延迟下，重做练习题4.10.3,考虑可能的时钟周期变化。假设分
支方向判断从EX级移到ID级时，ID 级的延迟增加50%，而EX级的延迟减少10ps。
4.10.6[10]<4.5>假设在分支时进行阻塞且没有使用延迟时间槽，如果beq指令的地址计算移到
MEM级，时钟周期将变为多少?该指令序列的总执行时间将变为多少?加速比是多少?假设分
支方向判断从EX级移到MEM级时，EX级的延迟减少20ps,而MEM级的延迟不变。

答:
4.10.1
在下图的流水线执行中，当一条指令因为在该周期内有一条加载或存储指令在使用，
而不能被获取时，就用***表示阻塞。周期从左到右表示，对于每条指令，我们显示它在该周期中所处的流水线阶段。

Instruction               Pipeline Stage
SW R16,12(R6)          IF  ID  EX  MEM  WB
LW R16,8(R6)               IF  ID  EX  MEM  WB
BEQ R5,R4,Lbl                  IF  ID  EX  MEM  WB
ADD R5,R1,R4                   *** *** IF  ID  EX  MEM  WB
SLT R5,R15,R4                              IF  ID  EX  MEM  WB

我们不能在代码中添加NOP来消除这种危险
NOP需要像其他指令一样被获取，
所以这种冒险必须由处理器中的硬件冒险检测单元来解决。

4.10.2
在整个没有数据冒险的执行过程中，这种改变只节省了一个周期。
这个周期的节省是因为最后一条指令提前完成了一个周期（少经历了一个阶段）。
如果有来自其他指令的lw的数据危险，这个改变将有助于消除一些阻塞周期。

Instruction Executed           Cycles with 5 stages       Cycles with 4 stages     Speedup
       5                             4 + 5 = 9                 3 + 5 = 8           9 / 8 = 1.13

4.10.3
Stall-on-branch 会延迟下一条指令的获取，直到分支被执行。当分支在EX阶段执行时，
每个分支会引起两个滞留周期。当分支在ID阶段执行时，每个分支只引起一个滞留周期。
在没有分支滞留的情况下（例如，有完美的分支预测），执行时间是4加执行指令的数量。

Instructions Executed      Branches Executed     Cycles with branch in EX      Cycles with branch in ID   Speedup
          5                       1                 4 + 5 + 1 * 2 = 11            4 + 5 + 1 * 1 = 10    11/10=1.10


4.10.4
4.10.2中已经计算了（正常）5级和（EX/MEM组合）4级流水线的周期数。时钟周期时间等于最长延迟的阶段的延迟。
只有当组合的EX/MEM级成为最长延迟级时，组合EX和MEM级才会影响时钟时间。

Cycle time with 5 stages        Cycle time with 4 stages         Speedup
      200ps (IF)                     210ps(MEM + 20ps)         (9 * 200) / (8 * 210) = 1.07


4.10.5
New ID latency        Nwe EX latency        New cycle time         Old cycle time         Speedup
180ps                     140ps                200ps(IF)              200ps(IF)           (11*200)/(10*200) = 1.10

4.10.6
周期时间保持不变：EX延迟减少20ps对时钟周期时间没有影响，因为EX不是延迟最长的阶段。
这一变化确实影响了执行时间，因为它为每个分支增加了一个额外的停顿周期。
因为时钟周期时间没有改善，但是周期数增加了，这个变化带来的速度提升将低于1（减速）。
在4.10.3中，我们已经计算了分支在EX阶段时的周期数。

Cycles with branch in EX           Execution time (branch in EX)         Cycles with branch in MEM         Execution time(branch in MEM)     Speedup
4 + 5 + 1 * 2 = 11                     11 * 200ps = 2200ps                   4 + 5 + 1 * 3 = 12               12 * 200ps = 2400ps               0.92